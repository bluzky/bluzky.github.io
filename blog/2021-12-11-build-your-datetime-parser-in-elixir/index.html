<!DOCTYPE html>
<html lang="en-US">
  <head>
  <meta charset="utf-8" />
  <title>The Organge+</title>

  <meta name="author" content="Dung Nguyen" />
  <meta
    name="description"
    content=""
  />

  <!-- mobile responsive meta -->
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=5"
  />

  <!-- Favicon -->
  <link
    rel="icon"
    href="/images/favicon.png"
    type="image/x-icon"
  />

  <!-- CSS Plugins -->
  <!-- plugins + stylesheet -->
<link rel="preconnect" href="https://fonts.gstatic.com" />


<link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css" media="screen" />



<link rel="stylesheet" href="/css/style.css" media="screen" />



<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;600;700&display=swap" />


<link rel="stylesheet" href="/css/style.css" media="screen" />


  
  <script type=application/javascript>
   var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-40665301-3','auto'),ga('send','pageview'))</script>
  

</head>


  <body>
    <div style="min-height: calc(100vh - 65px)">
      <div class="header-height-fix"></div>
<header class="header-nav">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <nav class="navbar navbar-expand-lg navbar-light p-0">
          <a class="navbar-brand font-weight-bold mr-0" href="">
            
            <img
              loading="lazy"
              src="/images/logo.png"
              alt="The Organge+"
              height="35px"
            />
            
          </a>

          
          <button
            class="search-toggle d-inline-block d-lg-none ml-auto mr-3"
            data-toggle="search"
            aria-label="Search Toggle"
          >
            <i data-eva="search-outline"></i>
          </button>
          

          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navHeader"
            aria-controls="navHeader"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <i data-eva="menu-outline"></i>
            <i class="d-none" data-eva="close-outline"></i>
          </button>

          <div class="collapse navbar-collapse" id="navHeader">
            <ul
              class="navbar-nav mx-auto"
            >
              
              
              

              
              <li class="nav-item ">
                <a class="nav-link" href="/">Blog</a>
              </li>
              
              
              
              
              

              
              <li class="nav-item ">
                <a class="nav-link" href="/tags">Tags</a>
              </li>
              
              
              
              
              

              
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle d-inline-block "
                  href="#"
                  role="button"
                  data-toggle="dropdown"
                  aria-expanded="false"
                  >More</a
                >
                <ul class="dropdown-menu">
                  <li>
                    <a
                      class="dropdown-item "
                      href="/categories"
                      >Category</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item "
                      href="/elements"
                      >Elements</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item "
                      href="/privacy"
                      >Privacy</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item "
                      href="/terms-conditions"
                      >Terms & Conditions</a
                    >
                  </li></ul>
              </li>
              
              
              
              
              

              
              <li class="nav-item ">
                <a class="nav-link" href="/about">About me</a>
              </li>
              
              
              
            </ul>

            
            <div class="navbar-right d-none d-lg-inline-block">
              <ul class="social-links list-unstyled list-inline">
                <li class="list-inline-item ml-4 d-none d-lg-inline-block">
                  <button
                    class="search-toggle"
                    data-toggle="search"
                    aria-label="Search Toggle"
                  >
                    <i data-eva="search-outline"></i>
                  </button>
                </li>
              </ul>
            </div>
            
          </div>
        </nav>
      </div>
    </div>
  </div>
</header>


<div class="search-block">
  <div data-toggle="search-close">
    <i data-eva="close-outline" class="text-primary"></i>
  </div>
  <form action="/search/">
    <input
      id="search-query"
      name="s"
      type="search"
      placeholder="Type words &amp; hit enter"
      class="text-center"
      aria-label="search-query"
    />
  </form>
</div>



      
      <section class="section-sm pb-2 page-header">
  <div class="container">
    <div class="row">
      <div class="col-8 mx-auto text-center">
        
        <h3 class="mb-3 text-dark font-weight-bold">Build your date time parser in Elixir</h3>
        


        <ul class="list-inline breadcrumb-menu">
        
        <li class="list-inline-item"><a href="/">Home</a></li>
        
        
        
        
        
        
        
        <li class="list-inline-item">/ &nbsp; <a href="/blog">Blog</a></li>
        
        
        
        
        
        <li class="list-inline-item">/ &nbsp; <a href="/blog/2021-12-11-build-your-datetime-parser-in-elixir">2021-12-11-build-your-datetime-parser-in-elixir</a></li>
        
        
        
        </ul>
      </div>
    </div>
  </div>
</section>

      

      <!-- checking blog -->


<section class="section-sm">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="content"><p>Elixir does not have built-in date time parser function. In this post, I will show you how to create one using regex.
The idea is: </p><p><img src="/img/datetime-parser-flow.png" alt="datetime parser flow"></img></p><ol><li>Define a format string</li><li>Build regex pattern from format string</li><li>Compile datetime string with regex pattern</li><li>Build datetime struct from extracted parts.</li></ol><p>And we will have something like this:</p><pre><code class="elixir">Toolkit.DateTimeHelper.parse("18/12/21", "%d/%m/%y")
#> {:ok, ~U[2021-12-18 00:00:00Z]}</code></pre><h2 id="1-define-format-string">1. Define format string.</h2><p>For simplicity, we support some basic format using convention from <code class="inline">Calendar.strftime</code></p><table><thead><tr><th style="text-align: left;">format</th><th style="text-align: left;">description</th><th style="text-align: left;">value example</th></tr></thead><tbody><tr><td style="text-align: left;">H</td><td style="text-align: left;">24 hour</td><td style="text-align: left;">00 - 23</td></tr><tr><td style="text-align: left;">I</td><td style="text-align: left;">12 hour</td><td style="text-align: left;">00 - 12</td></tr><tr><td style="text-align: left;">M</td><td style="text-align: left;">minute</td><td style="text-align: left;">00 - 59</td></tr><tr><td style="text-align: left;">S</td><td style="text-align: left;">second</td><td style="text-align: left;">00 - 59</td></tr><tr><td style="text-align: left;">d</td><td style="text-align: left;">day</td><td style="text-align: left;">01 - 31</td></tr><tr><td style="text-align: left;">m</td><td style="text-align: left;">month</td><td style="text-align: left;">01 -12</td></tr><tr><td style="text-align: left;">y</td><td style="text-align: left;">2 digits year</td><td style="text-align: left;">00 - 99</td></tr><tr><td style="text-align: left;">Y</td><td style="text-align: left;">4 digits year</td><td style="text-align: left;"></td></tr><tr><td style="text-align: left;">z</td><td style="text-align: left;">timezone offset</td><td style="text-align: left;">+0100, -0330</td></tr><tr><td style="text-align: left;">Z</td><td style="text-align: left;">timezone name</td><td style="text-align: left;">UTC+7, Asia/Ho_Chi_Minh</td></tr><tr><td style="text-align: left;">p</td><td style="text-align: left;">PM or AM</td><td style="text-align: left;"></td></tr><tr><td style="text-align: left;">P</td><td style="text-align: left;">pm or am</td><td style="text-align: left;"></td></tr></tbody></table><pre><code class="elixir">defmodule DateTimeParser do
    @mapping %{
    "H" => "(?<hour>\\d{2})",
    "I" => "(?<hour12>\\d{2})",
    "M" => "(?<minute>\\d{2})",
    "S" => "(?<second>\\d{2})",
    "d" => "(?<day>\\d{2})",
    "m" => "(?<month>\\d{2})",
    "y" => "(?<year2>\\d{2})",
    "Y" => "(?<year>-?\\d{4})",
    "z" => "(?<tz>[+-]?\\d{4})",
    "Z" => "(?<tz_name>[a-zA-Z_\/]+)",
    "p" => "(?<p>PM|AM)",
    "P" => "(?<P>pm|am)",
    "%" => "%"
  }
end</code></pre><p>Here we define a mapping between format character and regex pattern. In the pattern we using named capture to assign name to matched content. This will help us handle datetime parts easier.</p><h2 id="2-build-regex-pattern-from-format-string">2. Build regex pattern from format string</h2><pre><code class="elixir">def build_regex(format) do
  keys = Map.keys(@mapping) |> Enum.join("")

  Regex.compile!("([^%]*)%([#{keys}])([^%]*)")
  |> Regex.scan(format)
  |> Enum.map(fn [_, s1, key, s2] ->
    [s1, Map.get(@mapping, key), s2]
  end)
  |> to_string()
  |> Regex.compile!()
end</code></pre><p>Here we scan for all string that start with <code class="inline">%</code> and followed by any of our format character which defined above. 
And then for each matching, we do replace the format with appropriate regex string.
Finally we compile it to a regex struct.</p><h2 id="3-capture-all-required-parts">3. Capture all required parts</h2><p>This is the easiest part. Regex do this for us.</p><pre><code class="elixir">def parse(dt_string, format \\ "%Y-%m-%dT%H:%M:%SZ") do
  format
  |> build_regex
  |> Regex.named_captures(dt_string)
  |> cast_data()
  |> to_datetime()
end</code></pre><p><code class="inline">cast_data</code> and <code class="inline">to_datetime</code> are defined right belows, don't worry.</p><h2 id="4-build-datetime-struct-from-captured-parts">4. Build datetime struct from captured parts</h2><p>This is the heavy part, we do it in 2 steps:</p><ol><li>Cast and validate data</li><li>Build datetime struct</li></ol><h3 id="4-1-cast-and-validate-data">4.1 Cast and validate data</h3><p>First we define some default values.</p><pre><code class="elixir">@default_value %{
    day: 1,
    month: 1,
    year: 0,
    hour: 0,
    minute: 0,
    second: 0,
    utc_offset: 0,
    tz_name: "UTC",
    shift: "AM"
}</code></pre><p>Then for each captured parts, we cast and validate each one until completed or got an error.</p><pre><code class="elixir">def cast_data(nil), do: {:error, "invalid datetime"}

def cast_data(captures) do
    captures
    |> Enum.reduce_while([], fn {part, value}, acc ->
      case cast(part, value) do
        {:ok, data} -> {:cont, [data | acc]}
        {:error, _} = error -> {:halt, error}
      end
    end)
    |> case do
      {:error, _} = error -> error
      data -> Enum.into(data, @default_value)
    end
end</code></pre><p>For each part we have different validation and logics. 
For part of days, we do upcase to make them same value so we handle them same way later:</p><pre><code class="elixir">  defp cast("P", value) do
    cast("p", String.upcase(value))
  end

  defp cast("p", value) do
    {:ok, {:shift, value}}
  end</code></pre><p>For timezone offset, we calculate <code class="inline">:utc_offset</code> in second. For timezone name, we keep it as is.</p><pre><code class="elixir">  defp cast("tz", value) do
    {hour, minute} = String.split_at(value, 3)

    with {:ok, {_, hour}} <- cast("offset_h", hour),
         {:ok, {_, minute}} <- cast("offset_m", minute) do
      sign = div(hour, abs(hour))
      {:ok, {:utc_offset, sign * (abs(hour) * 3600 + minute * 60)}}
    else
      _ -> {:error, "#{value} is invalid timezone offset"}
    end
  end

  defp cast("tz_name", value) do
    {:ok, {:tz_name, value}}
  end</code></pre><p>For other parts, we convert to integer and check against valid range.
Let's define some validation ranges:</p><pre><code class="elixir">  @value_rages %{
    "hour" => [0, 23],
    "hour12" => [0, 12],
    "minute" => [0, 59],
    "second" => [0, 59],
    "day" => [0, 31],
    "month" => [1, 12],
    "year2" => [0, 99]
  }

  defp cast(part, value) do
    value = String.to_integer(value)

    valid =
      case Map.get(@value_rages, part) do
        [min, max] ->
          value >= min and value <= max

        _ ->
          true
      end

    if valid do
      {:ok, {String.to_atom(part), value}}
    else
      {:error, "#{value} is not a valid #{part}"}
    end
  end</code></pre><h3 id="4-2-combine-those-all-parts">4.2 Combine those all parts</h3><p>For year with 2 digits, get 2 first digits of current year to make 4 digits year.</p><pre><code class="elixir">  defp to_datetime({:error, _} = error), do: error

  defp to_datetime(%{year2: value} = data) do
    current_year = DateTime.utc_now() |> Map.get(:year)
    year = div(current_year, 100) * 100 + value

    data
    |> Map.put(:year, year)
    |> Map.delete(:year2)
    |> to_datetime()
  end</code></pre><p>For 12 hours format, we convert to 24 hours.</p><pre><code class="elixir">  defp to_datetime(%{hour12: hour} = data) do
    # 12AM is not valid

    if hour == 12 and data.shift == "AM" do
      {:error, "12AM is invalid value"}
    else
      hour =
        cond do
          hour == 12 and data.shift == "PM" -> hour
          data.shift == "AM" -> hour
          data.shift == "PM" -> hour + 12
        end

      data
      |> Map.put(:hour, hour)
      |> Map.delete(:hour12)
      |> to_datetime()
    end
  end</code></pre><p>After handling special cases, we build <code class="inline">Date</code>, <code class="inline">Time</code> and combine them into <code class="inline">DateTime</code> struct and handle time zone name.</p><pre><code class="elixir">  defp to_datetime(data) do
    with {:ok, date} <- Date.new(data.year, data.month, data.day),
         {:ok, time} <- Time.new(data.hour, data.minute, data.second),
         {:ok, datetime} <- DateTime.new(date, time) do
      datetime = DateTime.add(datetime, -data.utc_offset, :second)

      if data.tz_name != "UTC" do
        DateTime.shift_zone(datetime, data.tz_name)
      else
        {:ok, datetime}
      end
    end
  end</code></pre><h2 id="conclusion">Conclusion</h2><p>There are many way to build datetime parser, but using regex, in my opinion, is simplest way and easiest to understand. You can build it yourself and add some more format, no need to add another dependency to your library.</p><p>You can see the fullsource code here on <a href="https://gist.github.com/bluzky/62a20cdb57b17f47c67261c10aa3da8b">gist</a>.</p><p>If you have any feedback or suggestion, leave me a comment.
Thanks for reading.</p></div>
      </div>
    </div>
  </div>
</section>


    </div>
    <footer class="section-sm p-0">
  <div class="container">
    <div class="row justify-content-center align-items-center">
      <div class="col-lg-5">
         
      </div>
      <div class="col-lg-12 text-center mb-3">
        
        <ul
          class="social-links icon-box list-unstyled list-inline font-weight-500 mb-3"
        >
          
        </ul>

        <p class="mb-0 font-weight-500 copyright-text content">
          Blog by Dung Nguyen.Theme by [Gethugothemes](https://gethugothemes.com/)
        </p>
      </div>
    </div>
  </div>
</footer>

    <!-- JS Plugins + Main script -->


<script data-turbolinks-suppress-warning src="/plugins/jquery/jquery.min.js"></script>
 

<script data-turbolinks-suppress-warning src="/plugins/bootstrap/bootstrap.min.js"></script>
 

<script data-turbolinks-suppress-warning src="/plugins/search/fuse.min.js"></script>
 

<script data-turbolinks-suppress-warning src="/plugins/search/mark.js"></script>
 

<script data-turbolinks-suppress-warning src="/plugins/search/search.js"></script>
 

<script src="https://unpkg.com/eva-icons"></script>
 

<script
  data-turbolinks-suppress-warning
  src="/js/script.js"
></script>

<!-- cookie -->


<!-- DISQUS -->

<script>
  /**
   *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
   *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
  /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
  */
  (function () {
    // DON'T EDIT BELOW THIS LINE
    var d = document,
      s = d.createElement("script");
    s.src = "https://.disqus.com/embed.js";
    s.setAttribute("data-timestamp", +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>


  </body>
</html>
